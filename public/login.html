<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Telegram Login</title>
</head>
<body style="display:flex;align-items:center;justify-content:center;height:100vh;background:#111;color:#fff;">
  <div style="text-align:center">
    <h2>Вход через Telegram</h2>
    <div id="widget"></div>
    <div id="msg" style="margin-top:12px;font-size:14px;color:#f88"></div>
  </div>

  <!-- Telegram Login Widget -->
  <script src="https://telegram.org/js/telegram-widget.js?22"
    data-telegram-login="AibmCheck_bot"
    data-size="large"
    data-onauth="onTelegramAuth(user)"
    data-request-access="write">
  </script>

  <script>
    async function onTelegramAuth(user) {
      const msg = document.getElementById("msg");
      msg.style.color = "#fff";
      msg.innerText = "⏳ Проверка доступа...";

      try {
        const r = await fetch("/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(user)
        });
        const data = await r.json();

        if (data.allowed) {
          msg.style.color = "#8ef08e";
          msg.innerText = "✅ Доступ разрешён. Перенаправление...";

          // сохраняем флаг, что проверка пройдена
          localStorage.setItem("__aibm_auth_ok", "1");

          // куда возвращаться
          const back = sessionStorage.getItem("__aibm_return_url") || "https://moomoo.io";

          setTimeout(() => { window.location.href = back; }, 1200);
        } else {
          msg.style.color = "#f88";
          msg.innerText = "⛔ Доступ запрещён";
        }
      } catch (err) {
        msg.style.color = "#f88";
        msg.innerText = "Ошибка соединения с сервером";
      }
    }
  </script>
</body>
</html>
